<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>[% title %]</title>
    <link rel="stylesheet" href="/codemirror/addon/dialog/dialog.css">
    <link rel="stylesheet" href="/codemirror/addon/search/matchesonscrollbar.css">
    <link rel="stylesheet" href="/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="/site.css">
    <script src="/jquery-3.3.1.min.js"></script>
    <script src="/codemirror/lib/codemirror.js"></script>
    <script src="/codemirror/mode/xml/xml.js"></script>
    <script src="/codemirror/addon/dialog/dialog.js"></script>
    <script src="/codemirror/addon/search/searchcursor.js"></script>
    <script src="/codemirror/addon/search/search.js"></script>
    <script src="/codemirror/addon/scroll/annotatescrollbar.js"></script>
    <script src="/codemirror/addon/search/matchesonscrollbar.js"></script>
    <script src="/codemirror/addon/search/jump-to-line.js"></script>
    <script src="/codemirror/mode/htmlmixed/htmlmixed.js"></script>
    <script src="/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="/codemirror/addon/edit/matchtags.js"></script>
    <script>
        $(function() {
            var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('editor'),
            {
                lineNumbers: true,
                matchBrackets: true,
                mode: "htmlmixed",
            });
            var variablesEditor = CodeMirror.fromTextArea(document.getElementById('variables'),
            {
                lineNumbers: true,
                matchBrackets: true,
                mode: "application/json",
            });

            var run = function() {
                $.post('/tt2?' + $('#engines').serialize(), { template: myCodeMirror.getValue(), vars: variablesEditor.getValue() },
                    function(data) {
                        var $output_div = $('<div>');
                        $.each(data.result, function(key, value) {
                            $output_div.append($('<h2>').text(key), $('<pre>').text(value));
                        });
                        $('#results').html($output_div);
                    }
                );
            };
            $('a.tt2').click(run);

            var clear = function() {
                myCodeMirror.setValue('');
                variablesEditor.setValue('');
                myCodeMirror.focus();
            };
            $('a.clear').click(clear);

            $('a.view').click(function() {
                $.post('/tt2?' + $('#engines').serialize(), { template: myCodeMirror.getValue(), vars: variablesEditor.getValue() },
                    function(data) {
                        var $output_div = $('<div>');
                        $.each(data.result, function(key, value) {
                            $output_div.append($('<h2>').text(key), $('<div>').html(value));
                        });
                        $('#results').html($output_div);
                    }
                );
            });
            document.onkeyup = function(event) {
                if(event.altKey && !event.shiftKey && !event.ctlKey) {
                    if(event.keyCode === 67) { // c
                        clear();
                    } else if(event.keyCode === 82) { // r
                        run();
                    } else if(event.keyCode === 84) { // t
                        myCodeMirror.focus();
                    } else if(event.keyCode === 86) { // v
                        variablesEditor.focus();
                    }
                }
            };
        });
    </script>
  </head>
  <body>
    [% content | none %]
  </body>
</html>

